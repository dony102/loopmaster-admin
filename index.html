<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1b2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>License Admin - LoopMaster Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1b2e 0%, #16172b 50%, #0d0e1a 100%);
            min-height: 100vh;
            color: #ffffff;
        }

        /* ==================== LOCK SCREEN ==================== */
        #lockScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1b2e 0%, #16172b 50%, #0d0e1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .lock-container {
            background: rgba(30, 32, 58, 0.9);
            border-radius: 16px;
            padding: 40px 32px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 340px;
        }

        .lock-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .lock-title {
            color: #a78bfa;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .lock-subtitle {
            color: #9ca3af;
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        .pin-input {
            background: rgba(26, 27, 46, 0.8);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 16px;
            width: 100%;
            font-size: 1.8rem;
            letter-spacing: 12px;
            text-align: center;
            color: #00d4ff;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s;
        }

        .pin-input:focus {
            border-color: #00d4ff;
        }

        .pin-input::placeholder {
            color: #4b5563;
            letter-spacing: 4px;
            font-size: 1rem;
        }

        .unlock-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .unlock-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .error-msg {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 12px;
            display: none;
        }

        .error-msg.show {
            display: block;
            animation: shake 0.3s ease;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* ==================== MAIN APP ==================== */
        #mainApp {
            display: none;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        h1 span {
            font-size: 2rem;
            margin-right: 10px;
        }

        .info-banner {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .info-banner .icon {
            background: #00d4ff;
            color: #1a1b2e;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .card {
            background: rgba(45, 46, 82, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-title.generate {
            color: #00d4ff;
        }

        .card-title.reset {
            color: #10b981;
        }

        .card-title.revoke {
            color: #ef4444;
        }

        .card-title.database {
            color: #8b5cf6;
        }

        .card-subtitle {
            color: #9ca3af;
            font-size: 0.85rem;
            margin-bottom: 14px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        input[type="text"] {
            flex: 1;
            min-width: 200px;
            background: rgba(26, 27, 46, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            color: #ffffff;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #00d4ff;
        }

        input[type="text"]::placeholder {
            color: #6b7280;
        }

        button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        button:active {
            transform: translateY(0);
        }

        .btn-generate {
            background: #00d4ff;
            color: #1a1b2e;
        }

        .btn-reset {
            background: #10b981;
            color: #ffffff;
        }

        .btn-revoke {
            background: #ef4444;
            color: #ffffff;
        }

        .btn-refresh {
            background: #8b5cf6;
            color: #ffffff;
            margin-bottom: 12px;
        }

        .result-box {
            margin-top: 14px;
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .result-label {
            color: #9ca3af;
            font-size: 0.8rem;
            margin-bottom: 6px;
        }

        .result-value {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            color: #00d4ff;
            word-break: break-all;
            cursor: pointer;
            padding: 8px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 4px;
        }

        .result-value:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .copy-hint {
            color: #6b7280;
            font-size: 0.75rem;
            margin-top: 6px;
        }

        /* Database Table */
        .table-container {
            overflow-x: auto;
            margin-top: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #9ca3af;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-active {
            color: #10b981;
            font-weight: 600;
        }

        .status-revoked {
            color: #ef4444;
            font-weight: 600;
        }

        .license-count {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: #fbbf24;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #6b7280;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            font-size: 0.9rem;
        }

        .toast.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Logout button */
        .logout-btn {
            position: fixed;
            top: 16px;
            right: 16px;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
    </style>
</head>

<body>
    <!-- LOCK SCREEN -->
    <div id="lockScreen">
        <div class="lock-container">
            <div class="lock-icon">üîê</div>
            <div class="lock-title">Admin Access</div>
            <div class="lock-subtitle">Enter PIN to continue</div>
            <input type="password" class="pin-input" id="pinInput" placeholder="Enter 6-digit" maxlength="6"
                inputmode="numeric" pattern="[0-9]*">
            <button class="unlock-btn" onclick="unlock()">
                üîì Unlock
            </button>
            <div class="error-msg" id="errorMsg">‚ùå PIN salah. Coba lagi.</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <button class="logout-btn" onclick="logout()">üö™ Lock</button>

        <div class="container">
            <h1><span>üîë</span>License Admin</h1>

            <div class="info-banner">
                <div class="icon">‚Ñπ</div>
                <span>Masukkan Machine ID dari user untuk generate license atau reset code.</span>
            </div>

            <!-- Generate License Key -->
            <div class="card">
                <div class="card-title generate">üîë Generate License Key</div>
                <div class="card-subtitle">Generate license key untuk aktivasi aplikasi</div>
                <div class="input-row">
                    <input type="text" id="machineIdInput" placeholder="Enter Machine ID">
                    <button class="btn-generate" onclick="generateLicense()">
                        üîë Generate
                    </button>
                </div>
                <div class="result-box" id="licenseResult">
                    <div class="result-label">Generated License Key:</div>
                    <div class="result-value" id="licenseValue" onclick="copyToClipboard(this.textContent)"></div>
                    <div class="copy-hint">üìã Tap to copy</div>
                </div>
            </div>

            <!-- Generate Reset Code -->
            <div class="card">
                <div class="card-title reset">üîÑ Generate Reset Code</div>
                <div class="card-subtitle">Reset trial ke 3/3 dan hapus license yang ada</div>
                <div class="input-row">
                    <input type="text" id="resetMachineId" placeholder="Enter Machine ID">
                    <button class="btn-reset" onclick="generateReset()">
                        üîÑ Reset
                    </button>
                </div>
                <div class="result-box" id="resetResult">
                    <div class="result-label">Reset Code:</div>
                    <div class="result-value" id="resetValue" onclick="copyToClipboard(this.textContent)"></div>
                    <div class="copy-hint">üìã Tap to copy</div>
                </div>
            </div>

            <!-- Revoke License -->
            <div class="card">
                <div class="card-title revoke">üö´ Revoke License</div>
                <div class="card-subtitle">Tandai license sebagai revoked</div>
                <div class="input-row">
                    <input type="text" id="revokeMachineId" placeholder="Enter Machine ID">
                    <button class="btn-revoke" onclick="revokeLicense()">
                        üö´ Revoke
                    </button>
                </div>
            </div>

            <!-- License Database -->
            <div class="card">
                <div class="card-title database">üìã License Database</div>
                <button class="btn-refresh" onclick="refreshDatabase()">üîÑ Refresh</button>

                <div class="license-count" id="licenseCount">
                    üîë Licenses (0)
                </div>

                <div class="table-container">
                    <table id="licenseTable">
                        <thead>
                            <tr>
                                <th>Machine ID</th>
                                <th>License Key</th>
                                <th>Created</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="licenseTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="empty-state" id="emptyState">
                    No licenses yet
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Copied!</div>

    <script>
        // ==================== CONFIG ====================
        // PIN untuk akses admin (6 digit)
        const ADMIN_PIN = "180201";

        // SECRET KEY - Must match LicenseManager.kt!
        const SECRET_KEY = "LOOPMASTER_PRO_2024_SECRET_KEY";

        // Storage keys
        const STORAGE_KEY = "loopmaster_licenses";
        const SESSION_KEY = "loopmaster_admin_session";

        // ==================== AUTH ====================
        function checkSession() {
            const session = sessionStorage.getItem(SESSION_KEY);
            if (session === "authenticated") {
                showApp();
            }
        }

        function unlock() {
            const pin = document.getElementById('pinInput').value;
            if (pin === ADMIN_PIN) {
                sessionStorage.setItem(SESSION_KEY, "authenticated");
                showApp();
            } else {
                document.getElementById('errorMsg').classList.add('show');
                document.getElementById('pinInput').value = '';
                setTimeout(() => {
                    document.getElementById('errorMsg').classList.remove('show');
                }, 2000);
            }
        }

        function logout() {
            sessionStorage.removeItem(SESSION_KEY);
            document.getElementById('lockScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('pinInput').value = '';
        }

        function showApp() {
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            refreshDatabase();
        }

        // Enter key to unlock
        document.getElementById('pinInput').addEventListener('keyup', function (e) {
            if (e.key === 'Enter') {
                unlock();
            }
        });

        // ==================== LICENSE FUNCTIONS ====================
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function generateLicenseKey(machineId) {
            const rawId = machineId.replace(/-/g, '').replace(/\s/g, '').toLowerCase();
            const input = rawId + SECRET_KEY;
            const hash = await sha256(input);
            const hex16 = hash.substring(0, 16).toUpperCase();
            return `${hex16.substr(0, 4)}-${hex16.substr(4, 4)}-${hex16.substr(8, 4)}-${hex16.substr(12, 4)}`;
        }

        async function generateResetCode(machineId) {
            const rawId = machineId.replace(/-/g, '').replace(/\s/g, '').toLowerCase();
            const input = rawId + SECRET_KEY + "_RESET";
            const hash = await sha256(input);
            const hex16 = hash.substring(0, 16).toUpperCase();
            return `RST-${hex16.substr(0, 4)}-${hex16.substr(4, 4)}-${hex16.substr(8, 4)}`;
        }

        function loadLicenses() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveLicenses(licenses) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(licenses));
        }

        async function generateLicense() {
            const machineId = document.getElementById('machineIdInput').value.trim();
            if (!machineId) {
                alert('Please enter a Machine ID');
                return;
            }

            const licenseKey = await generateLicenseKey(machineId);

            document.getElementById('licenseValue').textContent = licenseKey;
            document.getElementById('licenseResult').classList.add('show');

            const licenses = loadLicenses();
            const existing = licenses.find(l => l.machineId.toUpperCase() === machineId.toUpperCase());

            if (!existing) {
                licenses.push({
                    machineId: machineId.toUpperCase(),
                    licenseKey: licenseKey,
                    created: new Date().toISOString(),
                    status: 'active'
                });
                saveLicenses(licenses);
            }

            refreshDatabase();
        }

        async function generateReset() {
            const machineId = document.getElementById('resetMachineId').value.trim();
            if (!machineId) {
                alert('Please enter a Machine ID');
                return;
            }

            const resetCode = await generateResetCode(machineId);

            document.getElementById('resetValue').textContent = resetCode;
            document.getElementById('resetResult').classList.add('show');
        }

        function revokeLicense() {
            const machineId = document.getElementById('revokeMachineId').value.trim();
            if (!machineId) {
                alert('Please enter a Machine ID');
                return;
            }

            const licenses = loadLicenses();
            const license = licenses.find(l => l.machineId.toUpperCase() === machineId.toUpperCase());

            if (license) {
                license.status = 'revoked';
                saveLicenses(licenses);
                refreshDatabase();
                showToast('License revoked');
            } else {
                alert('Machine ID not found');
            }
        }

        function refreshDatabase() {
            const licenses = loadLicenses();
            const tbody = document.getElementById('licenseTableBody');
            const emptyState = document.getElementById('emptyState');
            const countEl = document.getElementById('licenseCount');

            countEl.textContent = `üîë Licenses (${licenses.length})`;

            if (licenses.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tbody.innerHTML = licenses.map(license => `
                <tr>
                    <td style="font-family: monospace; font-size: 0.75rem">${license.machineId}</td>
                    <td style="font-family: monospace; color: #00d4ff; font-size: 0.75rem">${license.licenseKey}</td>
                    <td style="font-size: 0.75rem">${formatDate(license.created)}</td>
                    <td class="${license.status === 'active' ? 'status-active' : 'status-revoked'}">
                        ${license.status === 'active' ? '‚úÖ' : 'üö´'}
                    </td>
                </tr>
            `).join('');
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: '2-digit'
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied!');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 1500);
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => { });
        }

        // Initialize
        checkSession();
    </script>
</body>

</html>